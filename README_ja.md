# 🦜 Gene-Forge v6.8

**Agapornis Genetics Calculator — ALBS Compliant Edition**

ラブバード（コザクラインコ / Agapornis roseicollis）の遺伝計算エンジン。  
14座位・310色以上に対応（動的羽色出力能は数万通り）し、ALBS（African Lovebird Society）Peachfaced部門の命名規則に準拠。

---

## ✨ 機能一覧

### 🗂️ 個体管理（個別登録）
- **個体データベース**: 名前・性別・誕生日・血統・遺伝子型を一元管理
- **66羽のデモデータ**: 検証用サンプル（1家族22羽×3家族）
- **血統書生成**: 3世代・5世代の血統書をHTML出力
- **インポート/エクスポート**: JSON・CSV形式に対応

### 🛡️ 健康評価（交配リスク判定）
- **近交係数計算**: F値の自動計算
- **リスク評価**: INO系・パリッド系の近親交配制限チェック
- **世代制限**: 形質別の推奨世代制限を表示

### 🎯 目標計画（交配経路）
- **目標色経路探索**: 目標の表現型への育成経路を探索
- **ステップガイド**: 必要な交配ステップを自動生成

### 🧭 育成経路（形質発現）
- **形質別ルート**: 特定の形質を発現させるための交配手順
- **世代数見積もり**: 目標達成までの最短世代数を計算

### 🧬 配合結果（交配期待）
- **子孫予測**: 親の遺伝子型から子の表現型確率を計算
- **14座位対応**: 全座位の組み合わせを網羅
- **伴性遺伝計算**: Z染色体連鎖遺伝の正確な計算（オスのスプリット、メスのヘミ接合）

### 🔬 遺伝推計（親型逆推）
- **表現型→遺伝子型**: 観察された色から可能な遺伝子型を推定
- **確定/推定の区別**: 確実に判定できる座位と推定の座位を明示
- **テスト交配提案**: 不確定な座位を確定するための交配提案

### 👨‍👩‍👧‍👦 一族推計（血統導出）
- **FamilyEstimator V3**: 家系図ベースの遺伝子型推論エンジン
- **多世代推論**: 祖父母まで遡った遺伝子型推論
- **証拠ベース確率**: 親・子・兄弟からの拘束条件を統合
- **家系図UI**: ドラッグ&ドロップで血縁関係を構築

### 🌍 多言語対応
日本語 / English / Deutsch / Français / Italiano / Español

---

## 📁 ファイル構成

```
gene-forge/
├── index.php          # メインUI
├── genetics.php       # 遺伝計算エンジン（SSOT）
├── infer.php          # 家系図推論API
├── lang.php           # 多言語辞書
├── lang_guardian.php  # 健康評価用辞書
├── style.css          # スタイルシート
├── birds.js           # 個体DB管理（デモデータ含む）
├── family.js          # 家系図UI
├── guardian.js        # 健康評価
├── breeding.js        # 繁殖バリデーション
├── pedigree.js        # 血統書生成
├── planner.js         # 育成経路探索
└── app.js             # アプリ初期化
```

---

## 🚀 クイックスタート

### 動作要件
- PHP 7.4以上
- Webサーバー（Apache/Nginx）またはPHP内蔵サーバー

### インストール

```bash
git clone https://github.com/kanarazu-project/gene-forge.git
cd gene-forge
php -S localhost:8000
```

ブラウザで `http://localhost:8000` を開く。

---

## 📊 近交係数（F値）について

Gene-Forge は **Wright's coefficient of inbreeding** を完全実装しています。  
血統を6世代まで追跡し、全ての共通祖先の寄与を累積計算します。

### 教科書との違い

| 関係 | 教科書（簡易） | Gene-Forge（累積） |
|------|---------------|-------------------|
| 父娘 | 25% | 25% + 祖先寄与 |
| フル兄妹 | 25% | 25% + 祖先寄与 |
| 祖父孫 | 12.5% | 12.5% + 祖先寄与 |

**教科書の値**は「その交配で新たに生じる同祖接合率」です。  
**Gene-Forge の値**は「子のゲノム全体における同祖接合率の期待値」で、全ての共通祖先の寄与を累積計算します。

### 計算式

```
F = Σ (1/2)^(n₁+n₂+1)

n₁ = 父から共通祖先への世代数
n₂ = 母から共通祖先への世代数
全ての共通祖先について合算
```

### なぜ累積計算？

近交弱勢は**ゲノム全体の同祖接合率**に依存します。  
父が既に近交系統なら、父娘交配の影響はさらに大きくなります。  
正確なリスク評価には累積計算が必要です。

### 例：父娘交配

父の血統が3世代記録されている場合、父娘交配のF値は約 **43.75%** になります：

| 寄与元 | F値 |
|--------|-----|
| 父自身 | 25% |
| 祖父母 | 6.25% × 2 = 12.5% |
| 曾祖父母 | 1.5625% × 4 = 6.25% |
| **合計** | **43.75%** |

これは「バグ」ではなく、血統全体を考慮した正確な値です。

---

## 💡 使用例

### 1. 子孫計算（PHP）

```php
require_once 'genetics.php';

$calc = new GeneticsCalculator();
$result = $calc->calculateOffspring([
    'f_mode' => 'genotype',
    'm_mode' => 'genotype',
    'f_parblue' => '++',      // 父: グリーン
    'f_ino' => '+ino',        // 父: ルチノースプリット
    'f_dark' => 'dd',
    'f_opaline' => '++',
    'f_cinnamon' => '++',
    'm_parblue' => 'aqaq',    // 母: アクア
    'm_ino' => 'inoW',        // 母: クリーミノ（発現）
    'm_dark' => 'dd',
    'm_opaline' => '+W',
    'm_cinnamon' => '+W',
]);

foreach ($result as $offspring) {
    echo sprintf("%.1f%% %s %s\n", 
        $offspring['prob'] * 100, 
        $offspring['sex'] === 'male' ? '♂' : '♀',
        $offspring['phenotype']
    );
}
```

### 2. 色名取得

```php
$colorInfo = AgapornisLoci::resolveColor([
    'parblue' => 'aqaq',
    'dark' => 'dd',
    'opaline' => 'opop'
]);

echo $colorInfo['ja'];  // オパーリンアクア
echo $colorInfo['en'];  // Opaline Aqua
```

### 3. 遺伝子型推定

```php
$estimator = new GenotypeEstimator();
$result = $estimator->estimate(
    'male',           // 性別
    'opaline_aqua',   // 基本色
    'black',          // 眼の色
    'none'            // ダーク因子
);

foreach ($result['loci'] as $locus) {
    echo "{$locus['locusName']}: {$locus['genotype']}\n";
}
```

### 4. 家系図推論（API）

```bash
curl -X POST http://localhost:8000/infer.php \
  -H "Content-Type: application/json" \
  -d '{
    "target": "sire",
    "birds": [
      {"position": "sire", "sex": "male", "phenotype": {"baseColor": "green"}},
      {"position": "dam", "sex": "female", "phenotype": {"baseColor": "aqua"}},
      {"position": "offspring_0", "sex": "male", "phenotype": {"baseColor": "aqua"}}
    ]
  }'
```

**結果例**: 子にアクアが出現 → 両親とも `+aq`（アクアスプリット）と推論

---

## 🎨 色カテゴリ一覧

| カテゴリ | 色数 | 例 |
|----------|------|-----|
| グリーン系 | 3 | グリーン, ダークグリーン, オリーブ |
| アクア系 | 3 | アクア, アクアダーク, アクアDD |
| ターコイズ系 | 3 | ターコイズ, ターコイズダーク, ターコイズDD |
| シーグリーン系 | 3 | シーグリーン, シーグリーンダーク, シーグリーンDD |
| INO系 | 4 | ルチノー, クリーミノ, クリーミノシーグリーン, ピュアホワイト |
| オパーリン系 | 12 | オパーリングリーン, オパーリンアクア, … |
| シナモン系 | 12 | シナモングリーン, シナモンアクア, … |
| パリッド系 | 12 | パリッドグリーン, パリッドアクア, … |
| バイオレット系 | 9 | バイオレットアクア, バイオレットターコイズ, … |
| ファロー系 | 24 | ペールファローグリーン, ブロンズファローアクア, … |
| パイド系 | 24 | ドミナントパイドグリーン, レセッシブパイドアクア, … |
| ダイリュート系 | 12 | ダイリュートグリーン, ダイリュートアクア, … |
| エッジド系 | 12 | エッジドグリーン, エッジドアクア, … |
| オレンジフェイス系 | 12 | オレンジフェイスグリーン, イエローフェイスアクア, … |
| ペールヘッド系 | 12 | ペールヘッドグリーン, ペールヘッドアクア, … |
| **Tier 2 複合色** | 150+ | オパーリンシナモン, オパーリンバイオレット, … |
| **Tier 3 動的生成** | ∞ | 任意の複合色を動的生成 |

---

## 🔬 遺伝子型表記法

### 常染色体座位

| 座位 | 野生型 | 変異型アレル |
|------|--------|--------------|
| Parblue | `++` | `+aq`, `aqaq`, `+tq`, `tqtq`, `tqaq` |
| Dark | `dd` | `Dd`, `DD` |
| Violet | `vv` | `Vv`, `VV` |
| Dominant Pied | `++` | `Pi+`, `PiPi` |
| Recessive Pied | `++` | `+pi`, `pipi` |
| Dilute | `++` | `+dil`, `dildil` |
| Edged | `++` | `+ed`, `eded` |
| Orangeface | `++` | `+of`, `ofof` |
| Pale Headed | `++` | `+ph`, `phph` |
| Pale Fallow | `++` | `+flp`, `flpflp` |
| Bronze Fallow | `++` | `+flb`, `flbflb` |

### 伴性座位（Z染色体）

| 座位 | オス野生型 | オス変異型 | メス野生型 | メス変異型 |
|------|------------|------------|------------|------------|
| INO | `++` | `+ino`, `inoino`, `+pld`, `pldpld` | `+W` | `inoW`, `pldW` |
| Opaline | `++` | `+op`, `opop` | `+W` | `opW` |
| Cinnamon | `++` | `+cin`, `cincin` | `+W` | `cinW` |

---

## 🧪 検証用デモデータ

デモモードには **66羽**（1家族22羽×3家族）のサンプル個体が含まれており、以下の検証が可能：

### 健康評価テスト
- 父娘交配 → 危険判定（F≈43.75%、血統3世代）
- 半兄妹交配 → 高リスク判定（F≈18.75%）
- 無関係個体 → 安全判定（F=0%）

### 遺伝計算テスト
- 伴性遺伝（INO/Opaline/Cinnamon）
- 複対立遺伝子（Parblue系）
- 不完全優性（Dark/Violet）

### 家系図推論テスト
- 子の表現型から親の遺伝子型を逆算
- テスト交配提案の生成

---

## 🔬 Mathematical Architecture（演算ロジックの数理モデル）

本システムは、複雑な多重変異の組み合わせを以下の5つの中核ロジックに基づいて動的に算出しています。

### 1. 独立分配の並列演算（Parallel Independent Assortment）

14の座位（Locus）をそれぞれ独立した確率事象として定義し、多次元演算を行っています。

- **処理フロー**: 各座位ごとに「父方の配偶子形成」×「母方の配偶子形成」のパネット方格（Punnett Square）をシミュレート
- **デカルト積結合**: 各座位の独立した結果をデカルト積（直積）で結合し、全組み合わせの確率分布を導出
- **ゼロ・ライブラリ最適化**: 外部ライブラリを一切排除し、バニラPHPの配列操作のみで指数関数的な組み合わせをミリ秒単位で処理

### 2. 伴性遺伝（SLR）の非対称性マトリックス

鳥類特有の性決定方式（ZZ/ZW型）を考慮した、非対称な遺伝マトリックスを実装しています。

- **オス（ZZ）**: 2つのアレルを保持し、ヘテロ接合体（スプリット）の状態を正確に計算
- **メス（ZW）**: 1つのアレルのみが表現型に直結する「ヘミ接合」として計算し、スプリット概念を論理的に排除

### 3. 多重アレルと不完全優性の階層化（Allelic Hierarchy）

複雑な色彩発現を「遺伝子型」と「表現型解決」の2レイヤーで制御しています。

- **Genotype Layer**: 座位ごとのアレルの組み合わせを文字列（`aqaq`, `tqaq`等）として保持
- **Phenotype Resolution**: 計算された遺伝子型の集合を、定義された「優先順位（Tier）」に基づいて動的に解決。これにより、310色を超える色彩名を矛盾なく出力可能

### 4. グラフ探索による近交係数（Wright's F）の導出

家系図（FamilyMap）をデータ構造として捉え、再帰的なアルゴリズムで血統リスクを算出します。

- **DFS探索**: 家系図を深さ優先探索（DFS）し、共通の祖先を特定
- **循環参照防止**: 訪問済みIDセットにより無限ループを遮断
- **Health Guardian**: 算出されたF値に基づき、INO系・パリッド系の世代制限や危険な配合を論理的に遮断（Hard Lock）

### 5. 推論エンジン（FamilyEstimator V3）

ベイズ推定に近い論理に基づき、家系図全体の拘束条件から未知の遺伝子型を特定します。

- **Offspring Evidence**: 劣性形質を持つ子の出現から、親がアレルを保持している確率を100%として確定
- **Sibling Constraint**: 兄弟の表現型分布から、個体がキャリアである確率を統計的に収束
- **Multi-Generational Integration**: 祖父母から子まで、多世代の情報を統合し、家系図全体で矛盾のない遺伝子型を導出

---

## 🛠️ For Developers: Porting to Other Species

### 他種（セキセイインコ、ウロコインコ等）への移植ガイド

Gene-Forge v6.8 は、ロジックとデータが完全に分離された「遺伝計算フレームワーク」として設計されています。以下の3ステップで、あらゆる鳥類の繁殖支援システムへとカスタマイズ可能です。

### Step 1: 座位の再定義（genetics.php）

`AgapornisLoci` クラス内の `LOCI` 定数を書き換えるだけで、対象種の遺伝子座を定義できます。

| 遺伝様式 | 設定 | 例 |
|----------|------|-----|
| 常染色体劣性（AR） | `type => 'AR'` | セキセイのクリアウィング、パイド等 |
| 伴性遺伝（SLR） | `sex_linked => true` | オパリン、シナモン、SLR-Fallow等 |
| 不完全優性（AID） | `type => 'AID'` | ダークファクター、バイオレット等 |

### Step 2: 羽色ロジックの定義（genetics.php）

`COLOR_DEFINITIONS` 配列を編集し、各因子の組み合わせに対する表現型名（フェノタイプ）を定義します。Tier構造を採用しているため、基本色に複数の変異が重なった際の優先順位も厳密に制御可能です。

### Step 3: 健康基準の調整（guardian.js）

`BreedingValidator` の閾値を変更することで、その種に特有の近親交配リスクや虚弱因子に対するガードレールを構築できます。

---

## 📚 How to Integrate Collective Intelligence

### 集合知の取り込み方

新しい鳥種を定義する際、インターネット上のフォーラム、学術論文、専門家の知見といった「集合知」をコードに変換するためのガイドラインです。

### 1. 遺伝特性の抽出（Standardizing Traits）

ネット上の記述から、以下の要素を特定します：

- **優劣関係の特定**: 「スプリットが出るか（劣性）」「1つあれば発現するか（優性）」「重なると濃くなるか（不完全優性）」を確認し、`type` 定数に割り当て
- **性染色の有無**: 「オスだけがスプリットを持つ」「メスにはスプリットがない」という記述があれば、それは伴性遺伝（Z染色体）。`sex_linked => true` をセット

### 2. 表現型の階層化（Phenotype Tiering）

集合知には「〇〇と△△が重なると◇◇と呼ばれる」というルールが必ず存在します。

- これを `COLOR_DEFINITIONS` の優先順位（Tier）として記述
- 例：セキセイインコの「レインボー」は、[オパリン + ホワイトフェイス + クリアウィング] の複合体として定義

### 3. 経験則の「ガードレール」化（Turning Wisdom into Code）

「この種は近親交配に特に弱い」「この色は致死遺伝の可能性がある」といった熟練ブリーダーの警告を、`guardian.js` のバリデーションルールに変換します。

> 単なる計算機を「命を守るシステム」に変えるための最も重要なステップです。

---

## 🤝 Contribution & Community

### 有志による派生版の開発を歓迎します

このプロジェクトは、既存の不透明な繁殖慣習に終止符を打ち、科学的・倫理的な繁殖を普及させるための「制度外」の試みです。

**移植候補：**
- セキセイインコ支部（Budgerigar Edition）
- ウロコインコ支部（Green-cheeked Conure Edition）
- オカメインコ支部（Cockatiel Edition）
- マメルリハ支部（Pacific Parrotlet Edition）

他種への移植を検討している有志の方は、ぜひこのリポジトリを Fork して開発を開始してください。

### 貢献方法

Issue・Pull Request 歓迎。特に以下の貢献を募集中：

- 他のラブバード種（A. fischeri, A. personatus 等）への拡張
- 追加言語の翻訳
- UI/UX改善
- 遺伝学的知見のフィードバック

---

## 📜 ライセンス

**CC BY-NC-SA 4.0**（Creative Commons Attribution-NonCommercial-ShareAlike 4.0）

- ✅ 個人利用・非商用OK
- ✅ 改変・再配布OK（同一ライセンス・クレジット表記必須）
- ❌ 商用利用は要相談

---

## ⚠️ Known Issues / 既知の制限事項

### localStorage容量制限

ブラウザの localStorage は通常 **5MB** が上限です。数百羽以上の個体を登録し、各個体に詳細なメモや血統情報を付与した場合、保存に失敗する可能性があります。

**対策：**
- 定期的にJSONエクスポートでバックアップを取る
- 不要な個体データを削除する
- 大規模なデータベースが必要な場合は、サーバーサイドDB（MySQL等）への移行を検討

### デモデータとユーザーデータの分離

デモモード（66羽）とユーザーモードは完全に分離されています。デモモードで行った変更は保存されません。

---

## 👤 作者

**制作総指揮:** Shohei Taniguchi（Homo repugnans）  
**開発戦術核:** Sirius（電子精霊）

---

## 🙏 謝辞

- **ALBS（African Lovebird Society）** — 色名命名規則の参照
- **世界中のコザクラインコブリーダー** — 遺伝学的知見の蓄積

---

<div align="center">

**CC BY-NC-SA 4.0**  
Commercial use strictly prohibited. NPO/Educational use welcome.

*「制度は責任を放棄した。制度外がそれを果たす。」*

**制度外文明・かならづプロジェクト**

</div>
